{% extends "base.html" %}

{% block title %}Leads - Personal CRM{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-high">Leads</h1>
    <a href="{{ url_for('leads.create') }}" class="btn-primary flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        New Lead
    </a>
</div>

{% if current_next_action or current_status or current_niche or current_source or current_search %}
<div class="glass-card p-4 mb-6 border-l-4 {% if current_next_action == 'overdue' %}border-cinnabar{% else %}border-cinnabar{% endif %}">
    <div class="flex justify-between items-center">
        <span class="font-medium text-high">
            Filters Applied:
            {% if current_next_action == 'overdue' %}Overdue Follow-Ups{% elif current_next_action == 'today' %}Due Today{% endif %}
            {% if current_status %}{% if current_next_action %}, {% endif %}Status: {{ current_status.replace('_', ' ').title() }}{% endif %}
            {% if current_niche %}{% if current_next_action or current_status %}, {% endif %}Niche: {{ current_niche }}{% endif %}
            {% if current_source %}{% if current_next_action or current_status or current_niche %}, {% endif %}Source: {{ current_source }}{% endif %}
            {% if current_search %}{% if current_next_action or current_status or current_niche or current_source %}, {% endif %}Search: "{{ current_search }}"{% endif %}
        </span>
        <a href="{{ url_for('leads.index') }}" class="text-sm text-cinnabar hover:text-cinnabar/80 transition-colors font-medium">Clear Filter</a>
    </div>
</div>
{% endif %}

<div class="glass-card p-5 mb-6">
    <form method="GET" class="grid grid-cols-1 md:grid-cols-7 gap-4">
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Status</label>
            <select name="status" class="w-full select-glass">
                <option value="">All Statuses</option>
                {% for status in statuses %}
                <option value="{{ status }}" {% if current_status == status %}selected{% endif %}>{{ status.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Niche</label>
            <select name="niche" class="w-full select-glass">
                <option value="">All Niches</option>
                {% for niche in niches %}
                <option value="{{ niche }}" {% if current_niche == niche %}selected{% endif %}>{{ niche }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Source</label>
            <select name="source" class="w-full select-glass">
                <option value="">All Sources</option>
                {% for source in sources %}
                <option value="{{ source }}" {% if current_source == source %}selected{% endif %}>{{ source }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Follow-Up</label>
            <select name="next_action" class="w-full select-glass">
                <option value="">All</option>
                <option value="today" {% if current_next_action == 'today' %}selected{% endif %}>Due Today</option>
                <option value="overdue" {% if current_next_action == 'overdue' %}selected{% endif %}>Overdue</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Sort By</label>
            <select name="sort" class="w-full select-glass">
                <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest First</option>
                <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                <option value="name_asc" {% if current_sort == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                <option value="name_desc" {% if current_sort == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
                <option value="status" {% if current_sort == 'status' %}selected{% endif %}>Status</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-medium mb-2">Search</label>
            <input type="text" name="search" value="{{ current_search }}" placeholder="Name or Business" 
                class="w-full input-glass">
        </div>
        <div class="flex items-end">
            <button type="submit" class="w-full btn-secondary">Filter</button>
        </div>
    </form>
</div>

<div class="glass-card overflow-hidden table-glass">
    <table class="min-w-full mobile-card-table">
        <thead>
            <tr>
                <th class="text-left">Name</th>
                <th class="text-left">Business</th>
                <th class="text-left">Website</th>
                <th class="text-left">Demo</th>
                <th class="text-left">Status</th>
                <th class="text-left">Next Action</th>
                <th class="text-left">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td data-label="Name">
                    <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 font-medium transition-colors">
                        {{ lead.name }}
                    </a>
                </td>
                <td data-label="Business" class="text-medium">{{ lead.business_name or '-' }}</td>
                <td data-label="Website">
                    {% if lead.has_website %}
                    <div class="space-y-1">
                        {% for issue in lead.website_quality.split(',') %}
                        <span class="pill pill-warning text-xs">
                            {{ issue.strip().replace('_', ' ').title() }}
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <span class="pill pill-cinnabar">No Website</span>
                    {% endif %}
                </td>
                <td data-label="Demo">
                    {% if lead.demo_site_built %}
                    <span class="pill pill-success">Built</span>
                    {% else %}
                    <span class="pill pill-neutral">Not Yet</span>
                    {% endif %}
                </td>
                <td data-label="Status">
                    <form method="POST" action="{{ url_for('leads.update_status', id=lead.id) }}" class="inline">
                        <select name="status" onchange="this.form.submit()" 
                            class="select-glass text-sm py-1.5 px-3
                            {% if lead.status == 'closed_won' %}!bg-green-500/20 !border-green-500/30 !text-green-400
                            {% elif lead.status == 'closed_lost' %}!bg-cinnabar/20 !border-cinnabar/30 !text-cinnabar
                            {% elif lead.status == 'new' %}!bg-aqua/20 !border-aqua/30 !text-aqua
                            {% endif %}">
                            {% for status in statuses %}
                            <option value="{{ status }}" {% if lead.status == status %}selected{% endif %}>
                                {{ status.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </td>
                <td data-label="Next Action" class="text-medium">{{ lead.next_action_date or '-' }}</td>
                <td data-label="Actions" class="space-x-3">
                    <div class="flex flex-wrap gap-2">
                        <a href="{{ url_for('leads.edit', id=lead.id) }}" class="text-aqua hover:text-aqua/80 text-sm transition-colors">Edit</a>
                        {% if lead.status != 'closed_won' %}
                        <a href="{{ url_for('leads.convert_to_client', id=lead.id) }}" class="text-green-400 hover:text-green-300 text-sm transition-colors">Convert</a>
                        {% endif %}
                        <form method="POST" action="{{ url_for('leads.archive', id=lead.id) }}" class="inline" onsubmit="return confirm('Archive this lead?')">
                            <button type="submit" class="text-cinnabar hover:text-cinnabar/80 text-sm transition-colors">Archive</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-12 text-low">No active leads found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if converted_leads %}
<div class="mt-8 glass-card overflow-hidden">
    <button onclick="toggleConvertedSection()" class="w-full p-5 flex items-center justify-between text-left hover:bg-white/5 transition-colors">
        <span class="text-lg font-semibold text-green-400">Converted Leads ({{ converted_leads|length }})</span>
        <svg id="convertedChevron" class="w-5 h-5 text-green-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    <div id="convertedSection" class="hidden border-t border-white/10">
        <div class="overflow-x-auto">
            <table class="min-w-full table-glass mobile-card-table">
                <thead>
                    <tr class="bg-green-500/20 border-b border-green-500/30" style="border-radius: 0;">
                        <th class="text-left text-green-400">Name</th>
                        <th class="text-left text-green-400">Business</th>
                        <th class="text-left text-green-400">Website Status</th>
                        <th class="text-left text-green-400">Demo Built</th>
                        <th class="text-left text-green-400">Converted</th>
                        <th class="text-left text-green-400">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in converted_leads %}
                    <tr>
                        <td data-label="Name">
                            <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 font-medium transition-colors">
                                {{ lead.name }}
                            </a>
                        </td>
                        <td data-label="Business" class="text-medium">{{ lead.business_name or '-' }}</td>
                        <td data-label="Website">
                            {% if lead.has_website %}
                            <div class="space-y-1">
                                {% for issue in lead.website_quality.split(',') %}
                                <span class="pill pill-warning text-xs">
                                    {{ issue.strip().replace('_', ' ').title() }}
                                </span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="pill pill-cinnabar">No Website</span>
                            {% endif %}
                        </td>
                        <td data-label="Demo">
                            {% if lead.demo_site_built %}
                            <span class="pill pill-success">Built</span>
                            {% else %}
                            <span class="pill pill-neutral">Not Built</span>
                            {% endif %}
                        </td>
                        <td data-label="Converted" class="text-medium">
                            {{ lead.converted_at.strftime('%Y-%m-%d') if lead.converted_at else '-' }}
                        </td>
                        <td data-label="Actions" class="space-x-3">
                            <div class="flex flex-wrap gap-2">
                                <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 text-sm transition-colors">View</a>
                                {% if lead.converted_client %}
                                <a href="{{ url_for('clients.detail', id=lead.converted_client[0].id) }}" class="text-green-400 hover:text-green-300 text-sm transition-colors">View Client</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if archived_leads %}
<div class="mt-6 glass-card overflow-hidden">
    <button onclick="toggleArchivedSection()" class="w-full p-5 flex items-center justify-between text-left hover:bg-white/5 transition-colors">
        <span class="text-lg font-semibold text-cinnabar">Archived Leads ({{ archived_leads|length }})</span>
        <svg id="archivedChevron" class="w-5 h-5 text-cinnabar transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    <div id="archivedSection" class="hidden border-t border-white/10">
        <div class="overflow-x-auto">
            <table class="min-w-full table-glass mobile-card-table">
                <thead>
                    <tr class="bg-cinnabar/20 border-b border-cinnabar/30" style="border-radius: 0;">
                        <th class="text-left text-cinnabar">Name</th>
                        <th class="text-left text-cinnabar">Business</th>
                        <th class="text-left text-cinnabar">Last Status</th>
                        <th class="text-left text-cinnabar">Archived</th>
                        <th class="text-left text-cinnabar">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in archived_leads %}
                    <tr>
                        <td data-label="Name">
                            <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 font-medium transition-colors">
                                {{ lead.name }}
                            </a>
                        </td>
                        <td data-label="Business" class="text-medium">{{ lead.business_name or '-' }}</td>
                        <td data-label="Status">
                            <span class="pill pill-neutral">{{ lead.status.replace('_', ' ').title() }}</span>
                        </td>
                        <td data-label="Archived" class="text-medium">
                            {{ lead.archived_at.strftime('%Y-%m-%d') if lead.archived_at else '-' }}
                        </td>
                        <td data-label="Actions" class="space-x-3">
                            <div class="flex flex-wrap gap-2">
                                <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 text-sm transition-colors">View</a>
                                <form method="POST" action="{{ url_for('leads.unarchive', id=lead.id) }}" class="inline">
                                    <button type="submit" class="text-green-400 hover:text-green-300 text-sm transition-colors">Restore</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if closed_lost_leads %}
<div class="mt-6 glass-card overflow-hidden">
    <button onclick="toggleLostSection()" class="w-full p-5 flex items-center justify-between text-left hover:bg-white/5 transition-colors">
        <span class="text-lg font-semibold text-medium">Lost Leads ({{ closed_lost_leads|length }})</span>
        <svg id="lostChevron" class="w-5 h-5 text-medium transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>
    <div id="lostSection" class="hidden border-t border-white/10">
        <div class="overflow-x-auto">
            <table class="min-w-full table-glass mobile-card-table">
                <thead>
                    <tr>
                        <th class="text-left">Name</th>
                        <th class="text-left">Business</th>
                        <th class="text-left">Close Reason</th>
                        <th class="text-left">Closed</th>
                        <th class="text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lead in closed_lost_leads %}
                    <tr>
                        <td data-label="Name">
                            <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 font-medium transition-colors">
                                {{ lead.name }}
                            </a>
                        </td>
                        <td data-label="Business" class="text-medium">{{ lead.business_name or '-' }}</td>
                        <td data-label="Close Reason" class="text-medium">{{ lead.close_reason or '-' }}</td>
                        <td data-label="Closed" class="text-medium">
                            {{ lead.closed_at.strftime('%Y-%m-%d') if lead.closed_at else '-' }}
                        </td>
                        <td data-label="Actions">
                            <a href="{{ url_for('leads.detail', id=lead.id) }}" class="text-aqua hover:text-aqua/80 text-sm transition-colors">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function toggleConvertedSection() {
    const section = document.getElementById('convertedSection');
    const chevron = document.getElementById('convertedChevron');
    section.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}

function toggleArchivedSection() {
    const section = document.getElementById('archivedSection');
    const chevron = document.getElementById('archivedChevron');
    section.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}

function toggleLostSection() {
    const section = document.getElementById('lostSection');
    const chevron = document.getElementById('lostChevron');
    section.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}
</script>
{% endblock %}
